# Monad Node role - Install and configure monad validator
---

# =============================================================================
# APT REPOSITORY SETUP
# =============================================================================
- name: Check if Category Labs GPG key exists
  stat:
    path: /etc/apt/keyrings/category-labs.gpg
  register: gpg_key_stat
  tags: [monad, install]

- name: Create apt keyrings directory
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: '0755'
  when: not gpg_key_stat.stat.exists
  tags: [monad, install]

- name: Download Category Labs GPG key
  get_url:
    url: https://pkg.category.xyz/category-labs.gpg
    dest: /etc/apt/keyrings/category-labs.gpg
    mode: '0644'
  when: not gpg_key_stat.stat.exists
  tags: [monad, install]

- name: Check if apt source exists
  stat:
    path: /etc/apt/sources.list.d/category-labs.sources
  register: apt_source_stat
  tags: [monad, install]

- name: Add Category Labs apt repository
  copy:
    content: |
      Types: deb
      URIs: https://pkg.category.xyz/
      Suites: noble
      Components: main
      Signed-By: /etc/apt/keyrings/category-labs.gpg
    dest: /etc/apt/sources.list.d/category-labs.sources
    mode: '0644'
  register: apt_repo
  when: not apt_source_stat.stat.exists
  tags: [monad, install]

- name: Update apt cache
  apt:
    update_cache: yes
  when: apt_repo.changed | default(false)
  tags: [monad, install]

# =============================================================================
# INSTALL MONAD PACKAGES
# =============================================================================
- name: Install monad package
  apt:
    name: monad
    state: present
  tags: [monad, install]

# =============================================================================
# CONFIGURATION DOWNLOADS
# =============================================================================
- name: Download validators config
  get_url:
    url: "{{ monad_validators_config_url }}"
    dest: "{{ monad_validators_config_file }}"
    mode: '0644'
    owner: "{{ monad_user }}"
    group: "{{ monad_group }}"
    force: yes
  tags: [monad, config]

- name: Download forkpoint config
  get_url:
    url: "{{ monad_forkpoint_config_url }}"
    dest: "{{ monad_forkpoint_file }}"
    mode: '0644'
    owner: "{{ monad_user }}"
    group: "{{ monad_group }}"
    force: yes
  tags: [monad, config]

# =============================================================================
# KEYS SETUP
# =============================================================================
- name: Check if SECP key exists
  stat:
    path: "{{ monad_secp_key_file }}"
  register: secp_key_stat
  tags: [monad, keys]

- name: Check if BLS key exists
  stat:
    path: "{{ monad_bls_key_file }}"
  register: bls_key_stat
  tags: [monad, keys]

- name: Create SECP keystore
  shell: |
    /usr/local/bin/monad-keystore import \
      --ikm "{{ vault_secp_ikm }}" \
      --key-type secp \
      --keystore-path {{ monad_secp_key_file }} \
      --password "{{ vault_keystore_password }}"
  become_user: "{{ monad_user }}"
  when: not secp_key_stat.stat.exists
  no_log: true
  tags: [monad, keys]

- name: Create BLS keystore
  shell: |
    /usr/local/bin/monad-keystore import \
      --ikm "{{ vault_bls_ikm }}" \
      --key-type bls \
      --keystore-path {{ monad_bls_key_file }} \
      --password "{{ vault_keystore_password }}"
  become_user: "{{ monad_user }}"
  when: not bls_key_stat.stat.exists
  no_log: true
  tags: [monad, keys]

- name: Secure key files
  file:
    path: "{{ item }}"
    owner: "{{ monad_user }}"
    group: "{{ monad_group }}"
    mode: '0600'
  loop:
    - "{{ monad_secp_key_file }}"
    - "{{ monad_bls_key_file }}"
  tags: [monad, keys]

# =============================================================================
# CONFIGURATION
# =============================================================================
- name: Generate name record signature
  shell: |
    /usr/local/bin/monad-sign-name-record \
      --address {{ ansible_host }}:{{ monad_p2p_port }} \
      --authenticated-udp-port {{ monad[type].consensus.ports.auth_udp_port }} \
      --self-record-seq-num 1 \
      --keystore-path {{ monad_secp_key_file }} \
      --password "{{ vault_keystore_password }}" 2>&1 | grep self_name_record_sig | cut -d'"' -f2
  register: name_record_sig_result
  changed_when: false
  no_log: true
  tags: [monad, config]

- name: Set name record signature fact
  set_fact:
    self_name_record_sig: "{{ name_record_sig_result.stdout }}"
  tags: [monad, config]

- name: Create monad environment file
  template:
    src: monad.env.j2
    dest: "{{ monad_general_env_file }}"
    owner: "{{ monad_user }}"
    group: "{{ monad_group }}"
    mode: '0600'
  tags: [monad, config]

- name: Create secrets environment file
  template:
    src: secrets.env.j2
    dest: "{{ monad_secrets_env_file }}"
    owner: "{{ monad_user }}"
    group: "{{ monad_group }}"
    mode: '0600'
  no_log: true
  tags: [monad, config]

- name: Create node.toml configuration
  template:
    src: node.toml.j2
    dest: "{{ monad_node_config_file }}"
    owner: "{{ monad_user }}"
    group: "{{ monad_group }}"
    mode: '0600'
  notify: Restart monad
  tags: [monad, config]

# =============================================================================
# SYSTEMD SERVICE
# =============================================================================
- name: Create systemd service for monad
  template:
    src: monad-consensus.service.j2
    dest: /etc/systemd/system/monad-consensus.service
    mode: '0644'
  register: systemd_service
  notify: Restart monad
  tags: [monad, systemd]

- name: Reload systemd daemon
  systemd:
    daemon_reload: yes
  when: systemd_service.changed
  tags: [monad, systemd]

- name: Enable and start monad service
  systemd:
    name: monad-consensus
    state: started
    enabled: yes
  tags: [monad, start]

# =============================================================================
# MANAGEMENT SCRIPTS
# =============================================================================
- name: Create monad management scripts
  template:
    src: "{{ item.src }}"
    dest: "{{ monad_home }}/scripts/{{ item.dest }}"
    owner: "{{ monad_user }}"
    group: "{{ monad_group }}"
    mode: '0755'
  loop:
    - { src: 'check-sync.sh.j2', dest: 'check-sync.sh' }
    - { src: 'restart-node.sh.j2', dest: 'restart-node.sh' }
    - { src: 'view-logs.sh.j2', dest: 'view-logs.sh' }
  tags: [monad, scripts]

# =============================================================================
# VERIFICATION
# =============================================================================
- name: Wait for monad service to start
  systemd:
    name: monad-consensus
  register: monad_service
  until: monad_service.status.ActiveState == "active"
  retries: 6
  delay: 10
  tags: [monad, verify]

- name: Display service status
  debug:
    msg: "Monad consensus service is {{ monad_service.status.ActiveState }}"
  tags: [monad, verify]
